<?php require('template/header.phtml'); ?>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">

                <!-- Quiz Header card
                 - Displays the title and short description.
                 - shows the progress bar and question counter while the user is taking the quiz.
                -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0">Financial Literacy Quiz</h2>
                    </div>
                    <div class="card-body">
                        <p class="lead">Test your knowledge about what you have learned about investing in the modules.</p>

                        <?php if (!$view->showResults): ?>
                        <!-- Progress bar:
                         - only shown during the quiz (before results)
                         - width is calculated based on the number of questions already answered.
                        -->
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped bg-success"
                                     role="progressbar"
                                     style="width: <?= ($view->currentQuestion - 1) / $view->totalQuestions * 100 ?>%"
                                     aria-valuenow="<?= $view->currentQuestion - 1 ?>"
                                     aria-valuemin="0"
                                     aria-valuemax="<?= $view->totalQuestions ?>">
                                </div>
                            </div>
                        <!-- Current question indicator -->
                            <p class="text-muted">
                                Question <?= $view->currentQuestion ?> of <?= $view->totalQuestions ?>
                            </p>
                        <?php endif; ?>
                    </div>
                </div>

                <!-- Main Quiz Content -->
                <?php if ($view->showResults): ?>
                    <!-- Results View
                      - Displayed once the user has completed the quiz.
                      - it shows, overall score as a percentage, feedback text, score, and action buttons
                    -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <h3 class="mb-0">Quiz Results</h3>
                        </div>
                        <div class="card-body text-center">
                            <!-- overall percentage score -->
                            <div class="display-1 fw-bold text-primary mb-3">
                                <?= $view->quizResults['percentage'] ?>%
                            </div>

                            <!-- Feedback summary and score breakdown -->
                            <div class="alert alert-info">
                                <h4 class="alert-heading"><?= $view->quizResults['feedback'] ?></h4>
                                <p>You scored <?= $view->quizResults['score'] ?> out of <?= $view->quizResults['total'] ?> questions correctly.</p>
                            </div>
                            <!-- Results action buttons (view details, retake, go to learning hub)
                              - Button to reveal detailed question-by-question breakdown
                            -->
                            <div class="mt-4 mb-4">
                                <?php if (!$view->showDetailedResults): ?>
                                    <form action="quiz.php" method="POST" class="d-inline">
                                        <button type="submit" name="show_details" class="btn btn-info btn-lg me-2">
                                            <i class="bi bi-eye"></i> View Detailed Results
                                        </button>
                                    </form>
                                <?php else: ?>
                                <!-- Button to hide detailed results and show only summary -->
                                    <form action="quiz.php" method="POST" class="d-inline">
                                        <button type="submit" name="hide_details" class="btn btn-secondary btn-lg me-2">
                                            <i class="bi bi-eye-slash"></i> Hide Detailed Results
                                        </button>
                                    </form>
                                <?php endif; ?>
                                <!-- Button to restart the quiz from the beginning-->
                                <form action="quiz.php" method="POST" class="d-inline">
                                    <button type="submit" name="restart" class="btn btn-primary btn-lg me-2">
                                        <i class="bi bi-arrow-repeat"></i> Retake Quiz
                                    </button>
                                </form>
                                <!-- Link back to the Learning Hub-->
                                <a href="learning-hub.php" class="btn btn-outline-primary btn-lg me-2">
                                    <i class="bi bi-book"></i> Learning Hub
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Results Section
                      - Only show when user chosen to view detailed results
                      - and detailed question data is available
                      - uses Bootstrap accordion to show each question with
                      - question text, user's answer (highlight as correct/incorrect)
                      - correct answer, explanation, and all question options
                      -->
                    <?php if ($view->showDetailedResults && !empty($view->detailedResults)): ?>
                        <div class="card shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h4 class="mb-0">
                                    <i class="bi bi-list-check"></i> Detailed Results
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="accordion" id="quizAccordion">
                                    <?php foreach ($view->detailedResults as $index => $result): ?>
                                    <!-- Accordion item for each question, bg-success for correct answers and danger for wrong
                                      - first item in expanded by default, others are collapsed.
                                    -->
                                        <div class="accordion-item mb-3">
                                            <h2 class="accordion-header" id="heading<?= $index ?>">
                                                <button class="accordion-button <?= $result['is_correct'] ? 'bg-success-subtle' : 'bg-danger-subtle' ?> <?= $index > 0 ? 'collapsed' : '' ?>"
                                                        type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#collapse<?= $index ?>"
                                                        aria-expanded="<?= $index === 0 ? 'true' : 'false' ?>"
                                                        aria-controls="collapse<?= $index ?>">
                                                <span class="me-3">
                                                    <strong>Question <?= $index + 1 ?>:</strong>
                                                    <?= htmlspecialchars($result['question']) ?>
                                                </span>
                                                    <!-- Badge indicating correct/incorrect -->
                                                    <span class="badge <?= $result['is_correct'] ? 'bg-success' : 'bg-danger' ?> ms-2">
                                                    <?= $result['is_correct'] ? '✓ Correct' : '✗ Incorrect' ?>
                                                </span>
                                                </button>
                                            </h2>
                                            <!-- Collapsible body containing answer details, explanation, and options -->
                                            <div id="collapse<?= $index ?>"
                                                 class="accordion-collapse collapse <?= $index === 0 ? 'show' : '' ?>"
                                                 aria-labelledby="heading<?= $index ?>"
                                                 data-bs-parent="#quizAccordion">
                                                <div class="accordion-body">
                                                    <div class="row">
                                                        <!-- User answer card -->
                                                        <div class="col-md-6">
                                                            <div class="card <?= $result['is_correct'] ? 'border-success' : 'border-danger' ?>">
                                                                <div class="card-header <?= $result['is_correct'] ? 'bg-success text-white' : 'bg-danger text-white' ?>">
                                                                    <h5 class="mb-0">Your Answer</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="card-text">
                                                                        <?php if ($result['user_answer_index'] !== null): ?>
                                                                        <!-- Display the user's selected answer, if not selected then show enumerated text-->
                                                                            <strong><?= htmlspecialchars($result['user_answer']) ?></strong>
                                                                        <?php else: ?>
                                                                            <em>Not answered</em>
                                                                        <?php endif; ?>
                                                                    </p>
                                                                    <!-- Warning message when the answer is incorrect -->
                                                                    <?php if (!$result['is_correct'] && $result['user_answer_index'] !== null): ?>
                                                                        <div class="alert alert-warning">
                                                                            <i class="bi bi-exclamation-triangle"></i>
                                                                            This answer is incorrect
                                                                        </div>
                                                                    <?php endif; ?>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- Correct answer card -->
                                                        <div class="col-md-6">
                                                            <div class="card border-success">
                                                                <div class="card-header bg-success text-white">
                                                                    <h5 class="mb-0">Correct Answer</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="card-text">
                                                                        <!-- Display the correct answer -->
                                                                        <strong><?= htmlspecialchars($result['correct_answer']) ?></strong>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Correct answer Explanation section -->
                                                    <div class="mt-4">
                                                        <div class="card border-info">
                                                            <div class="card-header bg-info text-white">
                                                                <h5 class="mb-0">
                                                                    <i class="bi bi-lightbulb"></i> Explanation
                                                                </h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <p class="card-text"><?= htmlspecialchars($result['explanation']) ?></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- List of all options of the questions
                                                     - List items styling
                                                     - Icon to visually indicate the role of each question
                                                     - highlight correct answer green, and red for wrong
                                                     - plain for all other options
                                                     -->
                                                    <div class="mt-3">
                                                        <h6>All Options:</h6>
                                                        <div class="list-group">
                                                            <?php foreach ($result['options'] as $optIndex => $option): ?>
                                                                <div class="list-group-item
                                                                <?= $optIndex == $result['correct_index'] ? 'list-group-item-success' : '' ?>
                                                                <?= $optIndex == $result['user_answer_index'] && !$result['is_correct'] ? 'list-group-item-danger' : '' ?>">
                                                                    <?php if ($optIndex == $result['correct_index']): ?>
                                                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                                    <?php elseif ($optIndex == $result['user_answer_index'] && !$result['is_correct']): ?>
                                                                        <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                                                    <?php else: ?>
                                                                        <i class="bi bi-circle me-2"></i>
                                                                    <?php endif; ?>
                                                                    <!-- Display option text -->
                                                                    <?= htmlspecialchars($option) ?>
                                                                </div>
                                                            <?php endforeach; ?>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                    <?php endif; ?>

                <?php elseif ($view->question): ?>
                    <!-- Question View
                      - Displayed while the user is actively taking the quiz
                      - shows the current question and its possible answers as radio buttons
                     -->
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h3 class="card-title mb-4">
                                Question <?= $view->currentQuestion ?>:
                                <?= htmlspecialchars($view->question['question']) ?>
                            </h3>
                            <!-- Question form
                             - Posts the selected answer back to quiz.php
                             - The answer field represents the index of the chosen option
                             - Preserve previously selected answer
                             -->
                            <form action="quiz.php" method="POST">
                                <div class="mb-4">
                                    <?php foreach ($view->question['options'] as $index => $option): ?>
                                    <!-- Individual answer option-->
                                        <div class="form-check mb-3">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="answer"
                                                   id="option<?= $index ?>"
                                                   value="<?= $index ?>"
                                                    <?= (isset($view->userAnswers['q' . $view->currentQuestion]) &&
                                                            $view->userAnswers['q' . $view->currentQuestion] == $index) ? 'checked' : '' ?>
                                                   required>
                                            <label class="form-check-label fs-5 ms-3" for="option<?= $index ?>">
                                                <?= htmlspecialchars($option) ?>
                                            </label>
                                        </div>
                                    <?php endforeach; ?>
                                </div>

                                <!-- Previous Buttons
                                  - "Previous" to go back to the previous question, if not on the first question
                                  - "Next Question" or "Finish Quiz" depending on whether this is the last question.
                                  -->

                                <div class="d-flex justify-content-between">
                                    <?php if ($view->currentQuestion > 1): ?>
                                        <a href="quiz.php?prev=true" class="btn btn-outline-secondary">
                                            <i class="bi bi-arrow-left"></i> Previous
                                        </a>
                                    <?php else: ?>
                                        <div></div> <!-- Spacer to keep layout aligned when there is no previous button-->
                                    <?php endif; ?>
                                    <!-- Submit/Next button-->
                                    <button type="submit" class="btn btn-primary px-4">
                                        <?= $view->currentQuestion == $view->totalQuestions ? 'Finish Quiz' : 'Next Question' ?>
                                        <i class="bi bi-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                <?php endif; ?>

                <!-- Contextual Help Text -->
                <div class="mt-4 text-center text-muted">
                    <small>
                        <i class="bi bi-info-circle"></i>
                        <?php if (!$view->showResults): ?>
                        <!-- While user is taking the quiz -->
                        Take your time to think about each question. There are no time limits!
                        <?php elseif ($view->showResults && !$view->showDetailedResults): ?>
                        <!-- User finished the quiz and viewing the result -->
                            Click "View Detailed Results" to see explanations for each question.
                        <?php elseif ($view->showDetailedResults): ?>
                            <!-- User viewing the detailed result -->
                            Review each question carefully to understand why answers were correct or incorrect.
                        <?php endif; ?>
                    </small>
                </div>

            </div>
        </div>
    </div>
<!-- Include the common page footer -->
<?php require('template/footer.phtml'); ?>