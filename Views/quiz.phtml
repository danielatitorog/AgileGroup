<?php require('template/header.phtml'); ?>

    <!-- required stylesheets -->
    <link href="../css/quiz-gamified.css" rel="stylesheet">
    <link href="../css/quizQuestions.css" rel="stylesheet">
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">

                <!--
                   CONDITIONAL HEADER AREA
                   If we are in "quiz mode" (questions are being shown), we display the
                   gamified header with:
                   - Quiz title & description
                   - Lives indicator (hearts, rendered by JS)
                   - Countdown timer
                   - Score, question counter, and total questions
                   - Visual progress bar

                   If we are in "results mode" ($view->showResults is true), we show a
                   simpler, classic card header appropriate for a results page.
               -->
                <?php if (!$view->showResults): ?>
                    <!-- Gamified header for quiz questions -->
                    <div class="quiz-game-header">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h2 class="mb-0 text-white"><?php echo htmlspecialchars($view->quizTitle); ?></h2>
                                <p class="mb-0 text-white-50"><?php echo htmlspecialchars($view->quizDescription); ?></p>
                            </div>
                            <div class="lives-container" id="lives-container">
                                <!-- Lives will be rendered by JavaScript -->
                            </div>
                        </div>

                        <!--
                           Timer display section.
                           The timer label is static text; the numeric value is updated by
                           the JavaScript timer logic. Initial value is a visual placeholder
                           and matches the configured 30-second limit.
                       -->

                        <div class="timer-container">
                            <div class="timer-label">Time Remaining</div>
                            <div class="timer-display" id="timer-display">00:30</div>
                        </div>

                        <!--
                            High-level stats row:
                            - Score: dynamic, powered by JS and persisted in sessionStorage.
                            - Question counter: uses server-side values to reflect current position.
                            - Total: number of questions in the quiz (static per quiz).
                        -->

                        <div class="game-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="score-display">0</span>
                                <span class="stat-label">Score</span>
                            </div>
                            <div class="stat-item">
                            <span class="stat-value" id="question-counter">
                                Question <?php echo $view->currentQuestion; ?> of <?php echo $view->totalQuestions; ?>
                            </span>
                                <span class="stat-label">Progress</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value"><?php echo $view->totalQuestions; ?></span>
                                <span class="stat-label">Total</span>
                            </div>
                        </div>

                        <!--
                            Visual progress bar.
                            The progress percentage is calculated on the server as:
                            (currentQuestion - 1) / totalQuestions * 100
                            This represents the portion of the quiz already completed
                            (questions fully answered so far).
                        -->
                        <div class="game-progress mt-3">
                            <div class="progress-container">
                                <div class="progress-bar-gamified" id="progress-bar-gamified"
                                     style="width: <?php echo ($view->currentQuestion - 1) / $view->totalQuestions * 100; ?>%">
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-white">Question <?php echo $view->currentQuestion; ?> of <?php echo $view->totalQuestions; ?></small>
                            </div>
                        </div>
                    </div>
                <?php else: ?>
                    <!-- Original header for results page -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h2 class="mb-0"><?php echo htmlspecialchars($view->quizTitle); ?></h2>
                        </div>
                        <div class="card-body">
                            <p class="lead"><?php echo htmlspecialchars($view->quizDescription); ?></p>
                        </div>
                    </div>
                <?php endif; ?>

                <!--
                    MAIN QUIZ CONTENT AREA
                    This section branches into three main modes:
                    1. Results view ($view->showResults === true)
                    2. Question view (show current question)
                    3. (Implicit) No content – if neither condition is met
                -->
                <?php if ($view->showResults): ?>
                    <!-- Results View with dynamic quiz title -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <h3 class="mb-0">Quiz Results - <?php echo htmlspecialchars($view->quizTitle); ?></h3>
                        </div>
                        <div class="card-body text-center">
                            <!-- overall percentage score -->
                            <div class="display-1 fw-bold text-primary mb-3">
                                <?php echo $view->quizResults['percentage']; ?>%
                            </div>

                            <!-- Feedback summary and score breakdown -->
                            <div class="alert alert-info">
                                <h4 class="alert-heading"><?php echo $view->quizResults['feedback']; ?></h4>
                                <p>You scored <?php echo $view->quizResults['score']; ?> out of <?php echo $view->quizResults['total']; ?> questions correctly.</p>
                            </div>
                            <!--
                                RESULTS ACTION BUTTONS
                                - View/Hide Detailed Results: toggles $view->showDetailedResults
                                - Retake This Quiz: restarts this specific quiz
                                - Back to Learning Hub: returns user to learning overview
                                -->
                            <div class="mt-4 d-flex justify-content-center gap-3">
                                <?php if (!$view->showDetailedResults): ?>
                                    <!--Include quiz parameter in form action -->
                                    <form action="quiz.php?quiz=<?php echo urlencode(isset($_SESSION['current_quiz']) ? $_SESSION['current_quiz'] : ''); ?>" method="POST" class="d-inline">
                                        <button type="submit" name="show_details" class="btn btn-info btn-lg me-2">
                                            <i class="bi bi-eye"></i> View Detailed Results
                                        </button>
                                    </form>
                                <?php else: ?>
                                    <form action="quiz.php?quiz=<?php echo urlencode(isset($_SESSION['current_quiz']) ? $_SESSION['current_quiz'] : ''); ?>" method="POST" class="d-inline">
                                        <button type="submit" name="hide_details" class="btn btn-secondary btn-lg me-2">
                                            <i class="bi bi-eye-slash"></i> Hide Detailed Results
                                        </button>
                                    </form>
                                <?php endif; ?>
                                <form action="quiz.php?quiz=<?php echo urlencode(isset($_SESSION['current_quiz']) ? $_SESSION['current_quiz'] : ''); ?>" method="POST" class="d-inline">
                                    <button type="submit" name="restart" class="btn btn-primary btn-lg me-2">
                                        <i class="bi bi-arrow-repeat"></i> Retake This Quiz
                                    </button>
                                </form>

                                <!-- Navigation to Learning Hub -->
                                <a href="learning_hub.php" class="btn btn-outline-primary btn-lg">
                                    <i class="bi bi-book"></i> Back to Learning Hub
                                </a>
                            </div>
                        </div>
                    </div>

                    <!--
                      DETAILED RESULTS SECTION
                      Only displayed when:
                      - $view->showDetailedResults is true AND
                      - $view->detailedResults is not empty
                      Each question is rendered as an accordion item with:
                      - Question text and correctness status in the header
                      - User answer and correct answer cards
                      - Explanation card
                      - A list of all options, visually marking correct and selected answers
                  -->
                    <?php if ($view->showDetailedResults && !empty($view->detailedResults)): ?>
                        <div class="card shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h4 class="mb-0">
                                    <i class="bi bi-list-check"></i> Detailed Results
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="accordion" id="quizAccordion">
                                    <?php foreach ($view->detailedResults as $index => $result): ?>
                                        <div class="accordion-item mb-3">
                                            <h2 class="accordion-header" id="heading<?php echo $index; ?>">
                                                <button class="accordion-button <?php echo $result['is_correct'] ? 'bg-success-subtle' : 'bg-danger-subtle'; ?> <?php echo $index > 0 ? 'collapsed' : ''; ?>"
                                                        type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#collapse<?php echo $index; ?>"
                                                        aria-expanded="<?php echo $index === 0 ? 'true' : 'false'; ?>"
                                                        aria-controls="collapse<?php echo $index; ?>">
                                            <span class="me-3">
                                                <strong>Question <?php echo $index + 1; ?>:</strong>
                                                <?php echo htmlspecialchars($result['question']); ?>
                                            </span>
                                                    <span class="badge <?php echo $result['is_correct'] ? 'bg-success' : 'bg-danger'; ?> ms-2">
                                                <?php echo $result['is_correct'] ? '✓ Correct' : '✗ Incorrect'; ?>
                                            </span>
                                                </button>
                                            </h2>
                                            <div id="collapse<?php echo $index; ?>"
                                                 class="accordion-collapse collapse <?php echo $index === 0 ? 'show' : ''; ?>"
                                                 aria-labelledby="heading<?php echo $index; ?>"
                                                 data-bs-parent="#quizAccordion">
                                                <div class="accordion-body">
                                                    <div class="row">
                                                        <!-- User Answer card -->
                                                        <div class="col-md-6">
                                                            <div class="card <?php echo $result['is_correct'] ? 'border-success' : 'border-danger'; ?>">
                                                                <div class="card-header <?php echo $result['is_correct'] ? 'bg-success text-white' : 'bg-danger text-white'; ?>">
                                                                    <h5 class="mb-0">Your Answer</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="card-text">
                                                                        <?php if ($result['user_answer_index'] !== null): ?>
                                                                            <strong><?php echo htmlspecialchars($result['user_answer']); ?></strong>
                                                                        <?php else: ?>
                                                                            <em>Not answered</em>
                                                                        <?php endif; ?>
                                                                    </p>
                                                                    <!-- Warning banner for incorrect user answers -->
                                                                    <?php if (!$result['is_correct'] && $result['user_answer_index'] !== null): ?>
                                                                        <div class="alert alert-warning">
                                                                            <i class="bi bi-exclamation-triangle"></i>
                                                                            This answer is incorrect
                                                                        </div>
                                                                    <?php endif; ?>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- Correct Answer card -->
                                                        <div class="col-md-6">
                                                            <div class="card border-success">
                                                                <div class="card-header bg-success text-white">
                                                                    <h5 class="mb-0">Correct Answer</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="card-text">
                                                                        <strong><?php echo htmlspecialchars($result['correct_answer']); ?></strong>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Explanation block to reinforce learning -->
                                                    <div class="mt-4">
                                                        <div class="card border-info">
                                                            <div class="card-header bg-info text-white">
                                                                <h5 class="mb-0">
                                                                    <i class="bi bi-lightbulb"></i> Explanation
                                                                </h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <p class="card-text"><?php echo htmlspecialchars($result['explanation']); ?></p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!--
                                                        List of all options.

                                                        Visual rules:
                                                        - Correct option: green background and check icon.
                                                        - Incorrect user chosen option: red background and cross icon.
                                                        - Others: neutral circle icon.
                                                    -->
                                                    <div class="mt-3">
                                                        <h6>All Options:</h6>
                                                        <div class="list-group">
                                                            <?php foreach ($result['options'] as $optIndex => $option): ?>
                                                                <div class="list-group-item
                                                            <?php echo $optIndex == $result['correct_index'] ? 'list-group-item-success' : ''; ?>
                                                            <?php echo ($optIndex == $result['user_answer_index'] && !$result['is_correct']) ? 'list-group-item-danger' : ''; ?>">
                                                                    <?php if ($optIndex == $result['correct_index']): ?>
                                                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                                    <?php elseif ($optIndex == $result['user_answer_index'] && !$result['is_correct']): ?>
                                                                        <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                                                    <?php else: ?>
                                                                        <i class="bi bi-circle me-2"></i>
                                                                    <?php endif; ?>
                                                                    <?php echo htmlspecialchars($option); ?>
                                                                </div>
                                                            <?php endforeach; ?>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                    <?php endif; ?>

                <?php elseif ($view->question): ?>

                    <!--
                        ACTIVE QUESTION VIEW
                        This branch is used when:
                        - We are NOT showing results ($view->showResults is false)
                        - We DO have an active question ($view->question is set)
                        The question is displayed inside the gamified question card,
                        and the answer options are styled for interactive selection
                        handled by the gamified JavaScript.
                    -->
                    <div class="question-card-gamified">
                        <h3 class="card-title mb-4" id="question-text">
                            <span class="badge bg-primary me-2">Q<?php echo $view->currentQuestion; ?></span>
                            <?php echo htmlspecialchars($view->question['question']); ?>
                        </h3>

                        <!-- Gamified form with data attribute for correct answer -->
                        <form class="quiz-form"
                              action="quiz.php?quiz=<?php echo urlencode(isset($_SESSION['current_quiz']) ? $_SESSION['current_quiz'] : ''); ?>"
                              method="POST"
                              data-correct-answer="<?php echo $view->question['correctIndex']; ?>">

                            <div class="answer-options-gamified">
                                <?php
                                foreach ($view->question['options'] as $index => $option):
                                    $letters = array('A', 'B', 'C', 'D');
                                    $letter = isset($letters[$index]) ? $letters[$index] : ($index + 1);
                                    ?>
                                    <div class="answer-option" data-index="<?php echo $index; ?>">
                                        <span class="option-letter"><?php echo $letter; ?></span>
                                        <?php echo htmlspecialchars($option); ?>
                                    </div>

                                    <!-- Hidden radio input for form submission -->
                                    <input class="form-check-input d-none"
                                           type="radio"
                                           name="answer"
                                           id="option<?php echo $index; ?>"
                                           value="<?php echo $index; ?>"
                                            <?php echo (isset($view->userAnswers['q' . $view->currentQuestion]) &&
                                                    $view->userAnswers['q' . $view->currentQuestion] == $index) ? 'checked' : ''; ?>
                                           required>
                                <?php endforeach; ?>
                            </div>

                            <!-- Navigation button to go onto next question, and finish quiz if it is last question -->
                            <div class="game-controls">

                                <button type="submit" class="game-button btn-next" id="next-button" disabled>
                                    <?php echo $view->currentQuestion == $view->totalQuestions ? 'Finish Quiz' : 'Next Question'; ?>
                                    <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                <?php endif; ?>

                <!-- Contextual Help Text, which change dynamically depending on the state of the quiz -->
                <div class="mt-4 text-center text-muted">
                    <small>
                        <i class="bi bi-info-circle"></i>
                        <?php if (!$view->showResults): ?>
                            Answer quickly to avoid losing lives! You have 30 seconds per question.
                        <?php elseif ($view->showResults && !$view->showDetailedResults): ?>
                            Click "View Detailed Results" to see explanations for each question.
                        <?php elseif ($view->showDetailedResults): ?>
                            Review each question carefully to understand why answers were correct or incorrect.
                        <?php endif; ?>
                    </small>
                </div>

            </div>
        </div>
    </div>

    <!--
       GAMIFIED QUIZ JAVASCRIPT
       quiz-gamified.js:
       - Drives the interactive game features on the client side:
         * Timer and visual countdown updates
         * Lives (hearts) management and animations
         * Score tracking and persistence in sessionStorage
         * Visual feedback for correct/incorrect answers (confetti, overlays)
         * Enabling/disabling navigation based on user interaction
   -->
    <script src="../js/quiz-gamified.js"></script>
<!-- Load required footer template -->
<?php require('template/footer.phtml'); ?>